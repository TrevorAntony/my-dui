name: DUFT Executables CI Pipeline
run-name: DUFT-Executables-Build-Pipeline
on:
  workflow_dispatch: # Allows manual trigger button
    branches:
      - main
  push:
    branches:
      - main
  schedule:
    - cron: "0 2 * * 1,3,5" # Repeat at 05:00am (EAT) of every Monday, Wednesday and Friday
jobs:
  build-linux-executables:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          repository: ${{github.repository}}
          path: main

      - name: Prepare node
        uses: actions/setup-node@v4
        with:
          node-version: '22.4.1'

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          miniforge-version: latest

      - name: Install conda-pack
        run: |
          conda install -c conda-forge conda-pack -y

      - name: Run server resources preparation script
        working-directory: main
        run: |
          sh scripts/shell/server_resources_preparation_actions.sh
        env:
          GITHUB_ORG: "UCSF-IGHS"
          GITHUB_TOKEN: ${{ secrets.DUFT_CLONE_TOKEN }}
          REPO2_REPO: "duft-config"
          REPO2_BRANCH: "namibia-3dl"
          REPO3_REPO: "duft-workspace-django"
          REPO3_BRANCH: "main"

      - name: Install yarn packages
        working-directory: main
        run: yarn install --legacy-peer-deps

      - name: Build executables
        working-directory: main
        env:
          GH_TOKEN: ${{ secrets.DUFT_PUBLISH_TOKEN }}
        run: yarn run build-and-package -- --linux

  build-windows-executables:
    runs-on: windows-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          repository: ${{github.repository}}
          path: main

      - name: Prepare node
        uses: actions/setup-node@v4
        with:
          node-version: '22.4.1'

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          miniforge-version: latest

      - name: Install conda-pack
        run: |
          conda install -c conda-forge conda-pack -y

      - name: Run server resources preparation script
        working-directory: main
        run: |
          powershell -ExecutionPolicy Bypass -File scripts/powershell/server_resources_preparation_actions.ps1
        env:
          GITHUB_ORG: "UCSF-IGHS"
          GITHUB_TOKEN: ${{ secrets.DUFT_CLONE_TOKEN }}
          REPO2_REPO: "duft-config"
          REPO2_BRANCH: "namibia-3dl"
          REPO3_REPO: "duft-workspace-django"
          REPO3_BRANCH: "main"

      - name: Install yarn packages
        working-directory: main
        run: yarn install --legacy-peer-deps

      - name: Build executables for x32 and x64 architectures of Windows platform
        working-directory: main
        env:
          GH_TOKEN: ${{ secrets.DUFT_PUBLISH_TOKEN }}
        run: yarn run build-and-package -- --win

  build-mac-executables:
    runs-on: macos-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          repository: ${{github.repository}}
          path: main

      - name: Prepare node
        uses: actions/setup-node@v4
        with:
          node-version: '22.4.1'

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          miniforge-version: latest

      - name: Install conda-pack
        run: |
          conda install -c conda-forge conda-pack -y

      - name: Run server resources preparation script
        working-directory: main
        run: |
          sh scripts/shell/server_resources_preparation_actions.sh
        env:
          GITHUB_ORG: "UCSF-IGHS"
          GITHUB_TOKEN: ${{ secrets.DUFT_CLONE_TOKEN }}
          REPO2_REPO: "duft-config"
          REPO2_BRANCH: "namibia-3dl"
          REPO3_REPO: "duft-workspace-django"
          REPO3_BRANCH: "main"

      - name: Install yarn packages
        working-directory: main
        run: yarn install --legacy-peer-deps

      - name: Build executables for MacOS platform
        working-directory: main
        env:
          GH_TOKEN: ${{ secrets.DUFT_PUBLISH_TOKEN }}
        run: yarn run build-and-package -- --mac